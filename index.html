<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TFA Packs ‚Äî Pro</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070b13; --grad1:#121a2a; --grad2:#0b1222; --ink:#e8f0ff; --muted:#9fb2d7;
  --chip:#1c2742; --accent:#6cf0ff; --accent2:#7b5cff; --good:#00dda2; --warn:#ffd257; --danger:#ff5c7a;
  --glass:rgba(255,255,255,.06); --ring:#2b395c; --card:#0e1627; --shadow:0 10px 30px rgba(0,0,0,.45);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:'Outfit',system-ui,Segoe UI,Roboto,Helvetica,Arial;background:
  radial-gradient(1200px 600px at 80% -10%, #111a33 0%, transparent 60%),
  radial-gradient(900px 500px at -10% 10%, #0b162f 0%, transparent 50%),
  linear-gradient(180deg, var(--grad1), var(--grad2)); color:var(--ink); -webkit-font-smoothing:antialiased}
.app{max-width:980px;margin:0 auto;padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px;border-radius:18px;background:var(--glass);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg at 50% 50%, #7b5cff, #00e0ff, #7b5cff);box-shadow:0 0 22px rgba(124,92,255,.45), inset 0 0 10px rgba(255,255,255,.15)}
.brand h1{font-size:18px;margin:0 0 -2px 0;font-weight:700}.sub{font-size:12px;color:var(--muted);letter-spacing:.2px}
.kpis{display:flex;gap:10px;align-items:center}
.kpi{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.08);font-weight:600}
.kpi .coin{width:20px;height:20px;border-radius:50%;background:radial-gradient(circle at 35% 35%, #fff, #bbc7d7 40%, #94a3ba 70%); box-shadow:inset 0 2px 3px rgba(0,0,0,.25)}
.btn{appearance:none;border:0;cursor:pointer;color:var(--ink);background:#1c2742;padding:10px 14px;border-radius:12px;font-weight:600}
.btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#00131c}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12)}
.btn.bad{background:linear-gradient(90deg, var(--danger), #ff8aa0); color:#25000a}
.btn.good{background:linear-gradient(90deg, var(--good), #77ffd8); color:#00221a}
.hero{margin:16px 0;padding:18px;border-radius:22px;background:
 linear-gradient(135deg, rgba(123,92,255,.25),rgba(108,240,255,.18)),
 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="400"><defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="%2300e0ff"/><stop offset="1" stop-color="%237b5cff"/></linearGradient></defs><g fill="none" stroke="url(%23g)" stroke-opacity=".35"><path d="M0 280C120 220 240 220 360 260s240 40 360 0 240-60 360-20" stroke-width="2"/></g></svg>') center/cover no-repeat;
 border:1px solid rgba(255,255,255,.10); box-shadow:var(--shadow); display:flex; justify-content:space-between; align-items:center; gap:12px; position:relative; overflow:hidden}
.hero .copy{max-width:66%}.hero h2{margin:0 0 6px;font-size:26px;letter-spacing:.2px}.hero p{margin:0;color:var(--muted)}.hero .cta{display:flex;gap:10px;margin-top:12px}
.hero .flare{position:absolute;inset:-40px -80px auto auto;width:320px;height:320px;filter:blur(30px);background:conic-gradient(from 90deg, rgba(255,255,255,0), rgba(124,92,255,.35), rgba(0,224,255,.35), rgba(255,255,255,0));border-radius:50%}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.tile{border-radius:18px;padding:18px;min-height:120px;background:var(--card);border:1px solid var(--ring);box-shadow:var(--shadow);position:relative;overflow:hidden;cursor:pointer;transition:transform .15s ease}
.tile:active{transform:scale(.98)} .tile h3{margin:0 0 6px;font-size:18px}
.tag{position:absolute;top:12px;right:12px;font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
.tile .hint{color:var(--muted);font-size:13px} .tile.gradient{background:linear-gradient(135deg, rgba(124,92,255,.18), rgba(0,224,255,.12), rgba(255,255,255,.02))}
.tabs{display:flex;gap:8px;margin:12px 0 16px}.tab{padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);cursor:pointer;font-weight:600;color:var(--muted)}
.tab.active{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#00131c}
.list{display:grid;gap:12px}
/* Player card layout - more breathing room */
.card{margin:6px 0;padding:16px;border-radius:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);line-height:1.35}
.card .row{display:flex;align-items:flex-start;flex-wrap:wrap;gap:14px}.card .ovr{font-size:30px;font-weight:900;margin-right:12px;min-width:44px}
.badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
.qs{margin-left:auto;white-space:nowrap}
/* Packs list */
.pack{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:14px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12)}
.pack .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);margin-right:6px}
.pack .price{font-weight:800}.pack .buy{padding:10px 14px;border-radius:12px;background:linear-gradient(90deg, var(--accent), var(--accent2));color:#00131c;border:0;font-weight:800;cursor:pointer}
/* Overlay */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:80}
.overlay.show{display:flex}.flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .2s ease}.flash.show{opacity:.9}
.reveal{width:min(920px,96%);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--ring);border-radius:20px;padding:16px;box-shadow:var(--shadow)}
.closeX{position:fixed;top:18px;right:18px;z-index:100}
/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:90}
.modal.show{display:flex}.sheet{width:min(560px,96%);background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
.sheet .head{display:flex;align-items:center;gap:10px}.sheet .big{font-size:46px;font-weight:900}.small{font-size:13px;color:var(--muted)}
/* Admin */
textarea.input{width:100%;min-height:120px;margin:8px 0;padding:10px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.12);color:var(--ink)}
@media(min-width:820px){.grid{grid-template-columns:repeat(4,1fr)}.tile{min-height:140px}}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand" id="openProfile" title="Profile & stats" style="cursor:pointer">
      <div class="logo"></div>
      <div>
        <h1 style="margin:0">TFA Packs ‚Äî <span style="font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent">Pro</span></h1>
        <div class="sub">Draft & Packs ‚Ä¢ Neon</div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><div class="coin"></div><span id="coins">0</span></div>
      <button class="btn ghost" id="dailyBtn">Daily +100k</button>
      <button class="btn primary" id="profileBtn">Profile</button>
    </div>
  </div>

  <section class="hero">
    <div class="copy">
      <h2>Build the ultimate club.</h2>
      <p>Open premium packs with full‚Äëscreen flashes, complete SBCs, and grow your collection. Admin tools included.</p>
      <div class="cta">
        <button class="btn primary" onclick="openTab('store')">Open Store</button>
        <button class="btn" onclick="openTab('club')">My Club</button>
      </div>
    </div>
    <div class="flare"></div>
  </section>

  <div class="grid" id="homeGrid">
    <div class="tile gradient" onclick="openTab('store')">
      <span class="tag">NEW</span>
      <h3>Packs</h3>
      <div class="hint">Store & My Packs</div>
    </div>
    <div class="tile" onclick="openTab('club')">
      <h3>Club</h3><div class="hint">Your players & quick sell</div>
    </div>
    <div class="tile" onclick="openTab('sbc')"><h3>SBC</h3><div class="hint">Submit squads ‚Ä¢ earn packs</div></div>
    <div class="tile" onclick="openTab('admin')"><h3>Info / Admin</h3><div class="hint">Import players ‚Ä¢ edit packs</div></div>
  </div>

  <!-- STORE -->
  <section id="store" style="display:none">
    <div class="tabs">
      <div class="tab active" id="tab-store" onclick="switchStore('store')">Store Packs</div>
      <div class="tab" id="tab-mine" onclick="switchStore('mine')">My Packs <span id="myCount" class="badge" style="margin-left:6px">0</span></div>
    </div>
    <div id="storeList" class="list"></div>
    <div id="mineList" class="list" style="display:none"></div>
  </section>

  <!-- CLUB -->
  <section id="club" style="display:none">
    <div class="tabs"><div class="tab active">My Club</div></div>
    <div class="row" style="gap:10px; margin:8px 0 12px">
      <input id="clubSearch" class="btn ghost" style="flex:1; min-width:200px" placeholder="Search name, club üèüÔ∏è, nation üá™üá∏, league, type">
      <select id="clubSort" class="btn ghost" style="min-width:190px">
        <option value="ratingDesc">Sort: Rating high ‚Üí low</option>
        <option value="ratingAsc">Sort: Rating low ‚Üí high</option>
        <option value="nameAsc">Sort: Name A ‚Üí Z</option>
        <option value="clubAsc">Sort: Club A ‚Üí Z</option>
      </select>
      <button class="btn bad" id="quickSellAll">Quick Sell All</button>
    </div>
    <div id="clubList" class="list"></div>
  </section>

  <!-- SBC -->
  <section id="sbc" style="display:none">
    <div class="tabs"><div class="tab active">SBCs</div></div>
    <div class="list" id="sbcList"></div>
  </section>

  <!-- ADMIN -->
  <section id="admin" style="display:none" class="admin">
    <div class="tabs">
      <div class="tab active" onclick="showAdmin('players')">Leagues & Players</div>
      <div class="tab" onclick="showAdmin('packs')">Packs</div>
      <div class="tab" onclick="showAdmin('types')">Card Types</div>
      <div class="tab" onclick="showAdmin('qs')">Quick Sell Ranges</div>
      <div class="tab" onclick="showAdmin('sim')">Simulator</div>
      <div class="tab" onclick="showAdmin('sbc')">SBC Creator</div>
      <div class="tab" onclick="showAdmin('save')">Save</div>
    </div>

    <!-- Leagues & Players -->
    <div id="admin-players">
      <div class="row" style="align-items:center">
        <select id="leagueSelect" class="btn ghost" style="min-width:220px"></select>
        <input id="leagueName" class="btn ghost" placeholder="New league name">
        <button class="btn" onclick="addLeague()">Add League</button>
        <button class="btn" onclick="exportLeague()">Export league</button>
        <span id="leagueToast" class="badge" style="display:none">Added ‚úì</span>
      </div>
      <p class="small">Paste JSON array of players {name, rating, position, club, league?, nation, type?, value?}</p>
      <textarea id="playersJson" class="input" placeholder='[{"name":"John Doe","rating":78,"position":"CM","club":"FC Demo","league":"Premier League","nation":"England"}]'></textarea>
      <div class="row">
        <button class="btn primary" onclick="importPlayers()">Import to League</button>
      </div>
    </div>

    <!-- Packs -->
    <div id="admin-packs" style="display:none">
      <h4>Packs (publish to store)</h4>
      <div class="small">Choose a <b>source</b> mode and value. Card Type pulls match a type; League pulls match a league.</div>
      <div class="row">
        <input class="btn ghost" id="packKey" placeholder="key (gold)">
        <input class="btn ghost" id="packTitle" placeholder="title (Gold 5)">
        <input class="btn ghost" id="packPrice" type="number" placeholder="price">
        <input class="btn ghost" id="packCount" type="number" placeholder="cards">
      </div>
      <div class="row" style="align-items:center">
        <select id="packSourceMode" class="btn ghost" onchange="refreshSourceSelect()">
          <option value="cardType">Source: Card Type</option>
          <option value="league">Source: League</option>
        </select>
        <select id="packSourceSelect" class="btn ghost" style="min-width:220px"></select>
        <input class="btn ghost" id="packMin" type="number" placeholder="min OVR">
        <input class="btn ghost" id="packMax" type="number" placeholder="max OVR">
        <label class="small" style="display:inline-flex;align-items:center;gap:6px">
          <input id="packIsPick" type="checkbox"> Player Pick (√ó3, choose 1)
        </label>
      </div>
      <div class="row">
        <textarea id="packOdds" class="input" placeholder='Odds JSON (sum ~100). Example: {"gold":92,"icon":2,"toty":1,"totw":5}'></textarea>
      </div>
      <div class="row">
        <button class="btn" onclick="addPack()">Add Pack</button>
        <button class="btn primary" onclick="saveAll()">Save Packs</button>
      </div>
      <div id="packToast" class="badge" style="display:none;margin-top:6px">Saved ‚úì</div>
      <div class="list" id="packTable"></div>
    </div>

    <!-- Card types -->
    <div id="admin-types" style="display:none">
      <h4>Card Types</h4>
      <div class="row" style="align-items:center">
        <input class="btn ghost" id="typeKey" placeholder="key (gold)">
        <input class="btn ghost" id="typeTitle" placeholder="title (Gold)">
        <input class="btn ghost" id="typeColor" placeholder="#ffd257">
        <input type="color" id="typeSwatch" class="btn ghost" value="#ffd257" onchange="EL('typeColor').value=this.value">
        <button class="btn" onclick="addCardType()">Add Type</button>
        <button class="btn primary" onclick="saveAll()">Save</button>
      </div>
      <div id="typeTable" class="list" style="margin-top:8px"></div>
    </div>

    <!-- QS ranges -->
    <div id="admin-qs" style="display:none">
      <h4>Quick Sell Ranges</h4>
      <div id="qsTable" class="list"></div>
    </div>

    <!-- Simulator -->
    <div id="admin-sim" style="display:none">
      <h4>Match Simulator rewards</h4>
      <div class="row small" style="align-items:center">
        Win: <input id="rewardWin" type="number" value="7500" class="btn ghost" style="width:120px">
        Draw: <input id="rewardDraw" type="number" value="2500" class="btn ghost" style="width:120px">
        Loss: <input id="rewardLoss" type="number" value="500" class="btn ghost" style="width:120px">
        Pack on Win:
        <select id="rewardPackKey" class="btn ghost" style="min-width:200px"></select>
        <button class="btn primary" onclick="saveSim()">Save</button>
        <button class="btn" onclick="simulateMatch()">Simulate now</button>
      </div>
      <p class="small" id="simMsg"></p>
    </div>

    <!-- SBC Creator -->
    <div id="admin-sbc" style="display:none">
      <h4>SBC Creator</h4>
      <div class="row" style="align-items:center">
        <input id="sbcKey" class="btn ghost" placeholder="key (PL_UPGRADE)">
        <input id="sbcTitle" class="btn ghost" placeholder="title (PL Upgrade)">
        <input id="sbcReq" class="btn ghost" style="flex:1" placeholder='requirements JSON ({"minOVR":80,"minPlayers":3,"league":"Premier League"})'>
        <input id="sbcReward" class="btn ghost" style="flex:1" placeholder='reward JSON ({"coins":5000,"pack":"gold"})'>
        <button class="btn" onclick="addSBC()">Add SBC</button>
        <button class="btn primary" onclick="saveAll()">Save</button>
      </div>
      <div id="sbcTable" class="list" style="margin-top:8px"></div>
    </div>

    <!-- Save -->
    <div id="admin-save" style="display:none">
      <h4>Save management</h4>
      <div class="row">
        <button class="btn" onclick="exportSave()">Export Save</button>
        <button class="btn" onclick="importSave()">Import Save</button>
        <button class="btn bad" onclick="hardReset()">Hard Reset</button>
      </div>
    </div>
  </section>

  <!-- PACK REVEAL OVERLAY -->
  <div id="ov" class="overlay">
    <button id="btnCloseOverlay" class="btn closeX">Exit</button>
    <div id="flash" class="flash"></div>
    <div class="reveal">
      <h4 id="revealTitle">You opened</h4>
      <div id="revealList" class="list"></div>
      <div class="row" style="gap:8px; margin-top:10px; justify-content:flex-end">
        <button id="btnSendAll" class="btn">Send all to club</button>
        <button id="btnQSAll" class="btn bad">Quick sell all</button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="row head">
        <div class="big" id="m-ovr">90</div>
        <div>
          <div id="m-name" style="font-weight:800;font-size:20px">Player Name</div>
          <div class="small"><span id="m-pos"></span> ‚Ä¢ <span id="m-club"></span> ‚Ä¢ <span id="m-league"></span> ‚Ä¢ <span id="m-nation"></span></div>
        </div>
        <div class="qs" id="m-value"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn bad" id="m-sell">Quick Sell</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <div class="nav">
    <button class="btn" onclick="openTab('home')">Home</button>
    <button class="btn" onclick="openTab('store')">Store</button>
    <button class="btn" onclick="openTab('club')">Club</button>
    <button class="btn" onclick="openTab('sbc')">SBC</button>
    <button class="btn" onclick="openTab('admin')">Info</button>
  </div>
</div>

<script>
/* ========= Utilities ========= */
const EL=id=>document.getElementById(id);
const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
const fmt=n=>(n??0).toLocaleString();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const pick=arr=>arr[Math.floor(Math.random()*arr.length)]||null;
const deep=x=>JSON.parse(JSON.stringify(x));
// --- flag emoji from country name ---
const ISO2 = {
  "England":"GB","Scotland":"GB","Wales":"GB",
  "Spain":"ES","France":"FR","Netherlands":"NL","Serbia":"RS","Argentina":"AR","Belgium":"BE",
  "Slovakia":"SK","Brazil":"BR","Hungary":"HU","Georgia":"GE","Algeria":"DZ","Germany":"DE",
  "Norway":"NO","Colombia":"CO","Austria":"AT","Portugal":"PT","USA":"US","United States":"US",
  "Slovenia":"SI","Cameroon":"CM","Ivory Coast":"CI","C√¥te d‚ÄôIvoire":"CI","Poland":"PL",
  "Australia":"AU","South Korea":"KR","Korea Republic":"KR","Ireland":"IE","Denmark":"DK","Sweden":"SE"
};
function flagEmoji(country){
  const cc = (ISO2[country]||"").toUpperCase();
  if(!/^[A-Z]{2}$/.test(cc)) return "";
  const cps = [...cc].map(c => 0x1F1E6 + (c.charCodeAt(0)-65));
  return String.fromCodePoint(...cps);
}
  const STADIUM='\\u{1F3DF}\\uFE0F'; // üèüÔ∏è
<div class="small">${p.pos} ‚Ä¢ üèüÔ∏è ${p.club} ‚Ä¢ <span class="badge">${p.league}</span> ‚Ä¢ ${flagEmoji(p.nation)} ${p.nation||''}</div>
const FLAGS={"England":"\\u{1F3F4}\\uE0067\\uE0062\\uE0065\\uE006E\\uE0067\\uE007F","Spain":"\\u{1F1EA}\\u{1F1F8}","France":"\\u{1F1EB}\\u{1F1F7}","Germany":"\\u{1F1E9}\\u{1F1EA}","Italy":"\\u{1F1EE}\\u{1F1F9}","Portugal":"\\u{1F1F5}\\u{1F1F9}","Argentina":"\\u{1F1E6}\\u{1F1F7}","Brazil":"\\u{1F1E7}\\u{1F1F7}","Netherlands":"\\u{1F1F3}\\u{1F1F1}","Belgium":"\\u{1F1E7}\\u{1F1EA}","Wales":"\\u{1F3F4}\\uE0067\\uE0062\\uE0077\\uE006C\\uE0073\\uE007F","USA":"\\u{1F1FA}\\u{1F1F8}","Saudi Arabia":"\\u{1F1F8}\\u{1F1E6}","Sweden":"\\u{1F1F8}\\u{1F1EA}","Serbia":"\\u{1F1F7}\\u{1F1F8}","Slovakia":"\\u{1F1F8}\\u{1F1F0}","Argentina":"\\u{1F1E6}\\u{1F1F7}","Denmark":"\\u{1F1E9}\\u{1F1F0}","Netherlands":"\\u{1F1F3}\\u{1F1F1}","Belgium":"\\u{1F1E7}\\u{1F1EA}","Hungary":"\\u{1F1ED}\\u{1F1FA}","Algeria":"\\u{1F1E9}\\u{1F1FF}","Cameroon":"\\u{1F1E8}\\u{1F1F2}","Norway":"\\u{1F1F3}\\u{1F1F4}","Colombia":"\\u{1F1E8}\\u{1F1F4}","Austria":"\\u{1F1E6}\\u{1F1F9}","Ghana":"\\u{1F1EC}\\u{1F1ED}","Switzerland":"\\u{1F1E8}\\u{1F1ED}","Georgia":"\\u{1F1EC}\\u{1F1EA}","Ivory Coast":"\\u{1F1E8}\\u{1F1EE}","Mozambique":"\\u{1F1F2}\\u{1F1FF}"};

/* ========= State ========= */
let state=store.get('tfa_state_v6',null);
if(!state){
  state={
    coins:500000,daily:0,
    stats:{packsOpened:0,playersPacked:0,coinsSpent:0,coinsFromQS:0,highestOVR:0,bestPull:null,packOpenCounts:{},duplicatesQS:0},
    cardTypes:{
      bronze:{title:'Bronze',color:'#a87a55'},silver:{title:'Silver',color:'#b9c7d6'},gold:{title:'Gold',color:'#ffd257'},
      icon:{title:'Icon',color:'#f7f3e8'},hero:{title:'Hero',color:'#ff3b6a'},fs:{title:'Future Stars',color:'#6a2cff'},
      toty:{title:'TOTY',color:'#2b5bff'},tots:{title:'TOTS',color:'#00c8a3'},
      ucl:{title:'UCL',color:'#0a84ff'},eul:{title:'EUL',color:'#ff7a00'}
    },
    qsRules:{bronze:{minOVR:50,maxOVR:64,minValue:100,maxValue:500},silver:{minOVR:65,maxOVR:74,minValue:600,maxValue:1500},gold:{minOVR:75,maxOVR:90,minValue:1000,maxValue:4000},icon:{minOVR:87,maxOVR:99,minValue:50000,maxValue:400000},hero:{minOVR:85,maxOVR:96,minValue:20000,maxValue:150000},fs:{minOVR:86,maxOVR:94,minValue:15000,maxValue:140000},toty:{minOVR:94,maxOVR:99,minValue:90000,maxValue:500000},tots:{minOVR:90,maxOVR:97,minValue:50000,maxValue:280000}},
    leagues:{},players:[],packs:{},club:[],myPacks:[],sim:{win:7500,draw:2500,loss:500,pack:'gold'},sbcs:{}
  };
  seedPlayers();
  seedSpecials();
  seedStarterPacks();
  saveAll();
}

/* ========= Seed base players ========= */
function seedPlayers(){
  const list=[{"name":"Kepa Arrizabalaga","rating":80,"position":"GK","nation":"Spain","club":"Arsenal"},{"name":"Martin Zubimendi","rating":83,"position":"CDM","nation":"Spain","club":"Arsenal"},{"name":"Christian N√∏rgaard","rating":79,"position":"CDM","nation":"Denmark","club":"Arsenal"},{"name":"Noni Madueke","rating":78,"position":"RW","nation":"England","club":"Arsenal"},{"name":"Viktor Gyokeres","rating":79,"position":"ST","nation":"Sweden","club":"Arsenal"},{"name":"Adrien Truffert","rating":77,"position":"LB","nation":"France","club":"Bournemouth"},{"name":"Marco Bizot","rating":79,"position":"GK","nation":"Netherlands","club":"Bournemouth"},{"name":"ƒêorƒëe Petroviƒá","rating":79,"position":"GK","nation":"Serbia","club":"Bournemouth"},{"name":"Jordan Henderson","rating":80,"position":"CM","nation":"England","club":"Brentford"},{"name":"Olivier Boscagli","rating":79,"position":"CB","nation":"France","club":"Brighton"},{"name":"Maxim De Cuyper","rating":77,"position":"LB","nation":"Belgium","club":"Brighton"},{"name":"Marcus Edwards","rating":79,"position":"RW","nation":"England","club":"Burnley"},{"name":"Kyle Walker","rating":83,"position":"RB","nation":"England","club":"Burnley"},{"name":"Martin D√∫bravka","rating":78,"position":"GK","nation":"Slovakia","club":"Burnley"},{"name":"Jo√£o Pedro","rating":78,"position":"ST","nation":"Brazil","club":"Chelsea"},{"name":"Walter Ben√≠tez","rating":79,"position":"GK","nation":"Argentina","club":"Crystal Palace"},{"name":"Kiernan Dewsbury-Hall","rating":78,"position":"CM","nation":"England","club":"Everton"},{"name":"Benjamin Lecomte","rating":77,"position":"GK","nation":"France","club":"Fulham"},{"name":"Lukas Nmecha","rating":77,"position":"ST","nation":"Germany","club":"Leeds United"},{"name":"Jaka Bijol","rating":76,"position":"CB","nation":"Slovenia","club":"Leeds United"},{"name":"Sean Longstaff","rating":76,"position":"CM","nation":"England","club":"Leeds United"},{"name":"Anton Stach","rating":77,"position":"CM","nation":"Germany","club":"Leeds United"},{"name":"Lucas Perri","rating":78,"position":"GK","nation":"Brazil","club":"Leeds United"},{"name":"Giorgi Mamardashvili","rating":80,"position":"GK","nation":"Georgia","club":"Liverpool"},{"name":"Jeremie Frimpong","rating":84,"position":"RB","nation":"Netherlands","club":"Liverpool"},{"name":"Florian Wirtz","rating":88,"position":"CAM","nation":"Germany","club":"Liverpool"},{"name":"Milos Kerkez","rating":77,"position":"LB","nation":"Hungary","club":"Liverpool"},{"name":"Hugo Ekitik√©","rating":76,"position":"ST","nation":"France","club":"Liverpool"},{"name":"Rayan A√Øt-Nouri","rating":79,"position":"LB","nation":"Algeria","club":"Manchester City"},{"name":"Rayan Cherki","rating":79,"position":"CAM","nation":"France","club":"Manchester City"},{"name":"Tijjani Reijnders","rating":84,"position":"CM","nation":"Netherlands","club":"Manchester City"},{"name":"James Trafford","rating":76,"position":"GK","nation":"England","club":"Manchester City"},{"name":"Matheus Cunha","rating":78,"position":"ST","nation":"Brazil","club":"Manchester United"},{"name":"Bryan Mbeumo","rating":80,"position":"RW","nation":"Cameroon","club":"Manchester United"},{"name":"Anthony Elanga","rating":80,"position":"LW","nation":"Sweden","club":"Newcastle United"},{"name":"Aaron Ramsdale","rating":84,"position":"GK","nation":"England","club":"Newcastle United"},{"name":"Dan Ndoye","rating":78,"position":"RW","nation":"Switzerland","club":"Nottingham Forest"},{"name":"Gianluca Busio","rating":80,"position":"CAM","nation":"USA","club":"Sunderland"},{"name":"Reinildo Mandava","rating":78,"position":"LB","nation":"Mozambique","club":"Sunderland"},{"name":"Simon Adingra","rating":76,"position":"RW","nation":"Ivory Coast","club":"Sunderland"},{"name":"Granit Xhaka","rating":82,"position":"CM","nation":"Switzerland","club":"Sunderland"},{"name":"Kevin Danso","rating":79,"position":"CB","nation":"Austria","club":"Tottenham Hotspur"},{"name":"Mathys Tel","rating":77,"position":"ST","nation":"France","club":"Tottenham Hotspur"},{"name":"Mohammed Kudus","rating":82,"position":"CAM","nation":"Ghana","club":"Tottenham Hotspur"},{"name":"Jo√£o Palhinha","rating":85,"position":"CDM","nation":"Portugal","club":"Tottenham Hotspur"},{"name":"Jean-Clair Todibo","rating":81,"position":"CB","nation":"France","club":"West Ham United"},{"name":"Kyle Walker-Peters","rating":78,"position":"RB","nation":"England","club":"West Ham United"},{"name":"Callum Wilson","rating":79,"position":"ST","nation":"England","club":"West Ham United"},{"name":"J√∏rgen Strand Larsen","rating":78,"position":"ST","nation":"Norway","club":"Wolverhampton Wanderers"},{"name":"Jhon Arias","rating":77,"position":"RW","nation":"Colombia","club":"Wolverhampton Wanderers"}];
  function typeFromRating(r){if(r<=64)return'bronze';if(r<=74)return'silver';return'gold'}
  const PL=['Arsenal','Bournemouth','Brentford','Brighton','Burnley','Chelsea','Crystal Palace','Everton','Fulham','Liverpool','Manchester City','Manchester United','Newcastle United','Nottingham Forest','Tottenham Hotspur','West Ham United','Wolverhampton Wanderers'];
  const CH=['Leeds United','Sunderland'];
  const leagueOfClub=club=>PL.includes(club)?'Premier League':(CH.includes(club)?'Championship':'All');
  list.forEach(p=>{
    const obj={name:p.name,ovr:p.rating,pos:p.position,club:p.club,league:leagueOfClub(p.club),nation:p.nation,type:typeFromRating(p.rating),value:Math.max(200,p.rating*30)};
    state.players.push(obj);
    state.leagues[obj.league]=state.leagues[obj.league]||[];
    state.leagues[obj.league].push(obj.name);
  });
  // Starter leagues (empty allowed)
  ['La Liga','Ligue 1','Serie A TIM','Bundesliga','Saudi Pro League'].forEach(L=>{ state.leagues[L]=state.leagues[L]||[]; });
}

/* Specials so special packs actually work */
function seedSpecials(){
  const positions=["GK","RB","LB","CB","CM","CDM","CAM","LW","RW","ST"];
  const nations=["England","Spain","France","Brazil","Germany","Italy","Portugal","Argentina","Netherlands"];
  function mk(type, n, min, max, club){
    for(let i=1;i<=n;i++){
      const o=min+Math.floor(Math.random()*(max-min+1));
      state.players.push({name:`${type.toUpperCase()} Star ${i}`,ovr:o,pos:pick(positions),club:club||"Special XI",league:type.toUpperCase(),nation:pick(nations),type:type});
    }
  }
  mk('icon',6,90,97,"Legends");
  mk('hero',6,86,92,"Heroes");
  mk('fs',6,86,93,"Future XI");
  mk('toty',6,94,99,"World XI");
  mk('tots',6,90,97,"Team of Season");
  mk('ucl',6,84,93,"Europe XI");
  mk('eul',6,82,90,"Europe League XI");
}

/* Starter packs */
function seedStarterPacks(){
  addPackDef({key:'bronze',title:'Bronze (5)',price:500,count:5,min:50,max:64,sourceMode:'cardType',source:'bronze',odds:{bronze:100}});
  addPackDef({key:'silver',title:'Silver (5)',price:2500,count:5,min:65,max:74,sourceMode:'cardType',source:'silver',odds:{silver:100}});
  addPackDef({key:'gold',title:'Gold (5)',price:6500,count:5,min:75,max:83,sourceMode:'cardType',source:'gold',odds:{gold:100}});
  addPackDef({key:'prem_gold',title:'Premium Gold (5)',price:9000,count:5,min:76,max:83,sourceMode:'cardType',source:'gold',odds:{gold:100}});
  addPackDef({key:'hero',title:'Hero (5)',price:280000,count:5,min:85,max:96,sourceMode:'cardType',source:'hero',odds:{hero:100}});
  addPackDef({key:'icon',title:'Icon (5)',price:450000,count:5,min:88,max:99,sourceMode:'cardType',source:'icon',odds:{icon:100}});
  addPackDef({key:'fs',title:'Future Stars (5)',price:120000,count:5,min:86,max:94,sourceMode:'cardType',source:'fs',odds:{fs:100}});
  addPackDef({key:'toty',title:'TOTY (5)',price:900000,count:5,min:94,max:99,sourceMode:'cardType',source:'toty',odds:{toty:100}});
  addPackDef({key:'tots',title:'TOTS (5)',price:420000,count:5,min:90,max:97,sourceMode:'cardType',source:'tots',odds:{tots:100}});
  addPackDef({key:'ucl',title:'UCL (5)',price:220000,count:5,min:84,max:93,sourceMode:'cardType',source:'ucl',odds:{ucl:100}});
  addPackDef({key:'eul',title:'EUL (5)',price:160000,count:5,min:82,max:90,sourceMode:'cardType',source:'eul',odds:{eul:100}});
  // League locked base
  ['Premier League','Championship'].forEach(L=>{
    addPackDef({key:(L.toLowerCase().replace(/[^a-z]+/g,'_'))+'_gold',title:`${L} Gold (5)`,price:7500,count:5,min:75,max:83,sourceMode:'league',source:L,odds:{gold:100}});
  });
}

/* ========= Persistence + Render boot ========= */
function saveAll(){store.set('tfa_state_v6',state);renderAll()}
function renderAll(){renderCoins(state.coins);renderStore();renderMine();renderClub();renderAdmin();renderSBCs();refreshSourceSelect();refreshWinPackSelect()}
function renderCoins(v){EL('coins').textContent=fmt(v)}

/* ========= Navigation ========= */
function openTab(id){['store','club','sbc','admin'].forEach(i=>EL(i).style.display='none'); if(id==='home'){window.scrollTo({top:0,behavior:'smooth'});return} EL(id).style.display='block'; window.scrollTo({top:EL(id).offsetTop-8,behavior:'smooth'})}
function switchStore(w){
  EL('tab-store').classList.toggle('active',w==='store');
  EL('tab-mine').classList.toggle('active',w==='mine');
  EL('storeList').style.display=w==='store'?'grid':'none';
  EL('mineList').style.display=w==='mine'?'grid':'none';
  if(w==='mine') renderMine(); else renderStore();
}

/* ========= Topbar actions ========= */
EL('dailyBtn').onclick=()=>{const d=new Date().toDateString();if(state.daily!==d){state.daily=d;state.coins+=100000;renderCoins(state.coins);saveAll()}};
EL('profileBtn').onclick=EL('openProfile').onclick=()=>{
  const s=state.stats;
  alert(`Coins: ${fmt(state.coins)}\\nClub size: ${state.club.length}\\nPacks in queue: ${state.myPacks.length}\\nPacks opened: ${s.packsOpened}\\nPlayers packed: ${s.playersPacked}\\nCoins spent: ${fmt(s.coinsSpent)}\\nCoins from QS: ${fmt(s.coinsFromQS)}\\nBest pull: ${s.bestPull? s.bestPull.name+' ('+s.bestPull.ovr+')' : '‚Äî'}`);
};

/* ========= Store / Packs ========= */
function addPackDef(o){state.packs[o.key]=o}
function renderStore(){
  const wrap=EL('storeList');wrap.innerHTML='';
  Object.entries(state.packs).forEach(([key,p])=>{
    const row=document.createElement('div');row.className='pack';
    row.innerHTML=`
      <div class="pill">${p.title}</div>
      <div class="small">${p.count||p.cards||5} cards ‚Ä¢ ${p.min}‚Äì${p.max} OVR ‚Ä¢ Source: ${p.sourceMode==='cardType'?p.source:('league:'+p.source)}${p.isPick?' ‚Ä¢ Player Pick':''}</div>
      <div><div class="price">${fmt(p.price)}</div><button class="buy">Buy</button></div>`;
    row.querySelector('.buy').onclick=()=>buyPack(key);
    wrap.appendChild(row);
  });
}
function renderMine(){
  const m=EL('mineList');m.innerHTML='';EL('myCount').textContent=state.myPacks.length;
  state.myPacks.forEach((key,i)=>{
    const p=state.packs[key];const row=document.createElement('div');row.className='pack';
    row.innerHTML=`<div class="pill">${p?.title||key}</div><div class="small">Ready to open</div><div><button class="buy">Open</button></div>`;
    row.querySelector('.buy').onclick=()=>openPack(key,i,true);
    m.appendChild(row);
  })
}
function buyPack(key){
  const p=state.packs[key]; if(!p) return;
  if(state.coins<p.price){alert('Not enough coins.'); return;}
  state.coins -= p.price; state.stats.coinsSpent += p.price; renderCoins(state.coins);
  openPack(key,null,false); saveAll();
}
function filterPoolByPack(p){
  let pool=state.players.filter(pl=>pl.ovr>=p.min&&pl.ovr<=p.max);
  if(p.sourceMode==='cardType') pool=pool.filter(pl=>String(pl.type).toLowerCase()===String(p.source).toLowerCase());
  else pool=pool.filter(pl=>pl.league===p.source);
  if(pool.length===0) pool=state.players.filter(pl=>pl.ovr>=p.min&&pl.ovr<=p.max);
  return pool;
}
function chooseTypeByOdds(odds){
  const entries=Object.entries(odds||{}); if(entries.length===0) return null;
  const total=entries.reduce((s,[_k,v])=>s+Number(v||0),0); if(total<=0) return null;
  const r=Math.random()*total; let acc=0;
  for(const [k,v] of entries){ acc+=Number(v||0); if(r<=acc) return k }
  return entries[entries.length-1][0];
}
let overlayCards=[];
function openPack(key,idxInQueue,fromQueue){
  const p=state.packs[key]; if(!p) return;
  if(fromQueue){ state.myPacks.splice(idxInQueue,1); saveAll(); renderMine(); }
  state.stats.packsOpened++;
  const basePool=filterPoolByPack(p);
  const cards=[];
  if(p.isPick){
    for(let i=0;i<3;i++){ cards.push(deep(pick(basePool))) }
    showPick(cards,chosen=>{ addToClub([chosen]); saveAll(); closeReveal(false); });
    return;
  }
  for(let i=0;i<(p.count||5);i++){
    let pool=basePool;
    const tPick=chooseTypeByOdds(p.odds);
    if(tPick){ const typed=basePool.filter(pl=>String(pl.type).toLowerCase()===String(tPick).toLowerCase()); if(typed.length) pool=typed; }
    cards.push(deep(pick(pool)));
  }
  cards.sort((a,b)=>b.ovr-a.ovr);
  flashType(cards[0].type); // animation color by card type
  showReveal(cards, p.title);
}
function flashType(typeKey){
  const color=(state.cardTypes[String(typeKey)?.toLowerCase()]?.color)||'#ffffff';
  const f=EL('flash'); f.style.background=color; f.classList.add('show');
  setTimeout(()=>f.classList.remove('show'),220);
}
function rarityClass(p){
  const t=(String(p.type)||'').toLowerCase();
  if(t==='icon') return 'r-icon';
  if(t==='toty') return 'r-toty';
  return p.ovr<=64?'r-bronze':p.ovr<=74?'r-silver':'r-gold';
}
function renderPlayer(p,withActions=true){
  const div=document.createElement('div'); div.className='card '+rarityClass(p);
  const typeKey=String(p.type||'').toLowerCase();
  const color=(state.cardTypes[typeKey]?.color)||'#ffffff';
  div.style.boxShadow=`inset 0 0 0 2px ${color}66, 0 10px 24px rgba(0,0,0,.25)`;
  const val=computeQSValue(p);
  const flag=(FLAGS[p.nation]||'');
  div.innerHTML=`
    <div class="row">
      <div class="ovr">${p.ovr}</div>
      <div style="min-width:200px;flex:1">
        <div style="font-weight:800;font-size:18px">${p.name} ${p.type?`<span class="badge">${(String(p.type)||'').toUpperCase()}</span>`:''}</div>
        <div class="small">${p.pos} ‚Ä¢ ${p.club} ${STADIUM} ‚Ä¢ <span class="badge">${p.league}</span> ‚Ä¢ ${flag} ${p.nation||''}</div>
        <div class="small">Value: ${fmt(val)}</div>
      </div>
      ${withActions?`<div class="qs"><button class="btn bad">Quick Sell ${fmt(val)}</button></div>`:''}
    </div>`;
  if(withActions){ div.querySelector('.btn').onclick=(ev)=>{ ev.stopPropagation(); const q=computeQSValue(p); state.coins+=q; state.stats.coinsFromQS+=q; removeFromClub(p); renderCoins(state.coins); saveAll(); }; }
  div.onclick=()=>showDetail(p);
  return div;
}
function showReveal(cards,title){
  overlayCards=cards;
  EL('revealTitle').textContent=`You opened: ${title}`;
  const body=EL('revealList'); body.innerHTML='';
  cards.forEach((c,i)=>{
    const card=renderPlayer(c,false);
    card.style.transform='rotateY(90deg)';
    card.style.transition='transform .22s ease';
    body.appendChild(card);
    setTimeout(()=>card.style.transform='rotateY(0deg)',80*i);
  });
  EL('ov').classList.add('show');
}
function showPick(cards,onChoose){
  overlayCards=[];
  EL('revealTitle').textContent='Player Pick ‚Äî choose 1 of 3';
  const body=EL('revealList'); body.innerHTML='';
  cards.forEach(c=>{
    const card=renderPlayer(c,false);
    card.style.cursor='pointer';
    card.onclick=()=>onChoose(c);
    body.appendChild(card);
  });
  EL('ov').classList.add('show');
}
function closeReveal(addToClubOnClose=true){
  if(addToClubOnClose && overlayCards && overlayCards.length){
    addToClub(overlayCards); overlayCards=[]; saveAll(); renderClub();
  }
  EL('ov').classList.remove('show');
}

/* ========= Club ========= */
function addToClub(cards){
  cards.forEach(p=>{
    state.club.push(p); state.stats.playersPacked++;
    if(p.ovr>state.stats.highestOVR){ state.stats.highestOVR=p.ovr; state.stats.bestPull={name:p.name,ovr:p.ovr,type:p.type}; }
  });
}
function removeFromClub(p){ const i=state.club.findIndex(x=>x===p); if(i>-1) state.club.splice(i,1); renderClub(); }
function computeQSValue(p){
  if(typeof p.qsValue==='number') return Math.max(0,Math.floor(p.qsValue));
  const key=String(p.type||'gold').toLowerCase();
  const r=state.qsRules[key]||{minOVR:50,maxOVR:99,minValue:100,maxValue:1000};
  const t=(clamp(p.ovr,r.minOVR,r.maxOVR)-r.minOVR)/Math.max(1,(r.maxOVR-r.minOVR));
  return Math.floor(r.minValue+(r.maxValue-r.minValue)*t);
}
function renderClub(){
  const q=EL('clubSearch').value?.trim().toLowerCase()||''; let arr=state.club.slice();
  const sort=EL('clubSort').value;
  if(q){ arr=arr.filter(p=>(p.name||'').toLowerCase().includes(q)||(p.club||'').toLowerCase().includes(q)||(p.league||'').toLowerCase().includes(q)||(String(p.type)||'').toLowerCase().includes(q)||(p.nation||'').toLowerCase().includes(q))}
  if(sort==='ratingDesc')arr.sort((a,b)=>b.ovr-a.ovr);
  if(sort==='ratingAsc')arr.sort((a,b)=>a.ovr-b.ovr);
  if(sort==='nameAsc')arr.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  if(sort==='clubAsc')arr.sort((a,b)=>(a.club||'').localeCompare(b.club||''));
  const wrap=EL('clubList'); wrap.innerHTML=''; arr.forEach(p=>wrap.appendChild(renderPlayer(p,true)));
}
EL('clubSearch').oninput=renderClub;
EL('clubSort').onchange=renderClub;
EL('quickSellAll').onclick=()=>{
  const total=state.club.reduce((s,p)=>s+computeQSValue(p),0);
  if(!state.club.length) return;
  if(confirm(`Quick sell ALL for ${fmt(total)} coins?`)){ state.coins+=total; state.stats.coinsFromQS+=total; state.club=[]; renderCoins(state.coins); saveAll(); renderClub(); }
};

/* ========= SBCs ========= */
function renderSBCs(){
  const wrap=EL('sbcList'); wrap.innerHTML='';
  const keys=Object.keys(state.sbcs); if(keys.length===0){ wrap.innerHTML='<div class="card small">No SBCs yet. Make some in Admin ‚Üí SBC Creator.</div>'; return; }
  keys.forEach(k=>{
    const s=state.sbcs[k]; const row=document.createElement('div'); row.className='pack';
    row.innerHTML=`<div class="pill">${s.title}</div><div class="small">Req: ${JSON.stringify(s.req)}</div><div><button class="buy">Attempt</button></div>`;
    row.querySelector('.buy').onclick=()=>completeSBC(k);
    wrap.appendChild(row);
  });
}
function addSBC(){
  const key=EL('sbcKey').value.trim(); if(!key) return;
  let req={}, reward={}; try{ req=JSON.parse(EL('sbcReq').value||'{}'); reward=JSON.parse(EL('sbcReward').value||'{}'); }catch(e){ alert('Bad JSON in req or reward'); return; }
  state.sbcs[key]={title:EL('sbcTitle').value||key,req,reward}; saveAll();
}
function completeSBC(key){
  const s=state.sbcs[key]; const req=s.req||{};
  const minOVR=req.minOVR||60, minPlayers=req.minPlayers||1, league=req.league||null, typeReq=(req.type||null);
  const eligible=state.club.filter(p=>p.ovr>=minOVR && (!league || p.league===league) && (!typeReq || String(p.type).toLowerCase()===String(typeReq).toLowerCase()));
  if(eligible.length<minPlayers){ alert('Not enough eligible players'); return; }
  // consume
  const used=eligible.slice(0,minPlayers);
  state.club = state.club.filter(p=>!used.includes(p));
  // reward
  if(s.reward?.coins){ state.coins+=Number(s.reward.coins)||0; }
  if(s.reward?.pack){ state.myPacks.push(s.reward.pack); }
  renderCoins(state.coins); saveAll(); renderMine(); renderClub();
  alert('SBC submitted. Reward ‚Üí My Packs.');
}

/* ========= Admin ========= */
function showAdmin(key){
  ['players','packs','types','qs','sim','sbc','save'].forEach(k=>EL('admin-'+k).style.display='none');
  EL('admin-'+key).style.display='block';
  EL('admin').scrollIntoView({behavior:'smooth',block:'start'});
}
function rebuildLeagueSelect(){
  const sel=EL('leagueSelect'); sel.innerHTML='';
  Object.keys(state.leagues).sort().forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); });
}
function addLeague(){
  const name=(EL('leagueName').value||'').trim(); if(!name) { alert('Enter a league name'); return; }
  state.leagues[name]=state.leagues[name]||[]; saveAll(); rebuildLeagueSelect();
  const t=EL('leagueToast'); t.textContent='Added ‚úì'; t.style.display='inline-block'; setTimeout(()=>t.style.display='none',1200);
  EL('leagueName').value='';
}
function importPlayers(){
  const league = EL('leagueSelect').value;
  let arr=[];
  try{ arr = JSON.parse(EL('playersJson').value); }catch{ alert('Invalid JSON'); return; }
  arr.forEach(p=>{
    const r=p.rating||p.ovr||70;
    const type=(p.type?String(p.type).toLowerCase():(r<=64?'bronze':r<=74?'silver':'gold'));
    const obj={name:p.name,ovr:r,pos:p.position||p.pos||'CM',club:p.club||'Free Agents',league:p.league||league,nation:p.nation||'',type:type,value:Math.max(200,r*30)};
    state.players.push(obj);
    state.leagues[obj.league]=state.leagues[obj.league]||[];
    state.leagues[obj.league].push(obj.name);
  });
  saveAll();
  alert(`Imported ${arr.length} players into ${league}.`);
}
function exportLeague(){
  const league=EL('leagueSelect').value;
  const names=state.leagues[league]||[];
  const arr=state.players.filter(p=>names.includes(p.name));
  navigator.clipboard.writeText(JSON.stringify(arr,null,2));
  alert('Copied to clipboard');
}
function refreshSourceSelect(){
  const mode=EL('packSourceMode').value;
  const sel=EL('packSourceSelect'); sel.innerHTML='';
  if(mode==='cardType'){
    Object.keys(state.cardTypes).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=`Type: ${k}`; sel.appendChild(o); });
  }else{
    Object.keys(state.leagues).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=`League: ${k}`; sel.appendChild(o); });
  }
}
function refreshWinPackSelect(){
  const sel=EL('rewardPackKey'); if(!sel) return; sel.innerHTML='';
  Object.keys(state.packs).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=state.packs[k].title||k; sel.appendChild(o); });
  sel.value=state.sim.pack||'';
}
function addPack(){
  const key=EL('packKey').value.trim(); if(!key) return;
  let odds={}; try{ odds = EL('packOdds').value.trim()? JSON.parse(EL('packOdds').value):{}; }catch{ odds = {}; }
  const o={
    key, title:EL('packTitle').value||key, price:parseInt(EL('packPrice').value||'0'),
    count:parseInt(EL('packCount').value||'5'),
    min:parseInt(EL('packMin').value||'50'),
    max:parseInt(EL('packMax').value||'99'),
    sourceMode:EL('packSourceMode').value,
    source:EL('packSourceSelect').value,
    isPick:EL('packIsPick').checked, odds
  };
  state.packs[key]=o; saveAll();
  const t=EL('packToast'); t.style.display='inline-block'; setTimeout(()=>t.style.display='none',1200);
  refreshWinPackSelect(); renderStore();
}
function renderAdmin(){
  rebuildLeagueSelect(); refreshWinPackSelect();
  // Types list
  const tWrap=EL('typeTable'); tWrap.innerHTML='';
  Object.entries(state.cardTypes).forEach(([k,v])=>{
    const row=document.createElement('div'); row.className='pack';
    row.innerHTML=`<div class="pill">${k}</div><div class="small">${v.title}</div><div><span class="badge" style="background:${v.color};color:#001">${v.color}</span> <button class="buy">Del</button></div>`;
    row.querySelector('.buy').onclick=()=>{ delete state.cardTypes[k]; saveAll(); refreshSourceSelect(); };
    tWrap.appendChild(row);
  });
  // Packs list
  const pWrap=EL('packTable'); pWrap.innerHTML='';
  Object.entries(state.packs).forEach(([k,p])=>{
    const row=document.createElement('div'); row.className='pack';
    row.innerHTML=`<div><div class="pill">${k}</div><div class="small">${p.title}</div></div>
      <div class="small">${p.count} cards ‚Ä¢ ${p.min}‚Äì${p.max} ‚Ä¢ ${p.sourceMode==='cardType'?'Type':'League'}: <b>${p.source}</b>${p.isPick?' ‚Ä¢ Pick':''}<br>Odds: ${Object.entries(p.odds||{}).map(([kk,vv])=>kk+':'+vv+'%').join(' ‚Ä¢ ')||'‚Äî'}</div>
      <div><div class="price">${fmt(p.price)}</div><button class="buy">Del</button></div>`;
    row.querySelector('.buy').onclick=()=>{ delete state.packs[k]; saveAll(); refreshWinPackSelect(); };
    pWrap.appendChild(row);
  });
  // QS table
  const qsWrap=EL('qsTable'); qsWrap.innerHTML='';
  Object.keys(state.qsRules).forEach(k=>{
    const r=state.qsRules[k];
    const row=document.createElement('div'); row.className='pack';
    row.innerHTML=`<div class="pill">${k}</div>
      <div class="small">minOVR <input class="btn ghost" style="width:80px" id="qs-${k}-minovr" value="${r.minOVR}"> maxOVR <input class="btn ghost" style="width:80px" id="qs-${k}-maxovr" value="${r.maxOVR}"> minValue <input class="btn ghost" style="width:100px" id="qs-${k}-minv" value="${r.minValue}"> maxValue <input class="btn ghost" style="width:100px" id="qs-${k}-maxv" value="${r.maxValue}"></div>
      <div><button class="buy">Save</button></div>`;
    row.querySelector('.buy').onclick=()=>{
      state.qsRules[k]={
        minOVR:Number(EL(`qs-${k}-minovr`).value)||r.minOVR,
        maxOVR:Number(EL(`qs-${k}-maxovr`).value)||r.maxOVR,
        minValue:Number(EL(`qs-${k}-minv`).value)||r.minValue,
        maxValue:Number(EL(`qs-${k}-maxv`).value)||r.maxValue
      };
      saveAll(); renderClub();
    };
    qsWrap.appendChild(row);
  });
  // SBC table
  const sWrap=EL('sbcTable'); sWrap.innerHTML='';
  Object.entries(state.sbcs).forEach(([k,v])=>{
    const row=document.createElement('div'); row.className='pack';
    row.innerHTML=`<div class="pill">${k}</div><div class="small">${v.title}</div><div><button class="buy">Del</button></div>`;
    row.querySelector('.buy').onclick=()=>{ delete state.sbcs[k]; saveAll(); };
    sWrap.appendChild(row);
  });
}
function addCardType(){
  const k=EL('typeKey').value.trim().toLowerCase();
  const title=EL('typeTitle').value.trim();
  const color=(EL('typeColor').value.trim()||'#ffd257');
  if(!k||!title) return;
  state.cardTypes[k]={title,color}; saveAll(); refreshSourceSelect(); renderAdmin();
}

/* ========= Simulator ========= */
function saveSim(){
  state.sim.win = parseInt(EL('rewardWin').value||'0');
  state.sim.draw= parseInt(EL('rewardDraw').value||'0');
  state.sim.loss= parseInt(EL('rewardLoss').value||'0');
  state.sim.pack= EL('rewardPackKey').value;
  saveAll(); EL('simMsg').textContent='Saved.';
}
function simulateMatch(){
  const r=Math.random();
  let result='Loss', coins=state.sim.loss;
  if(r<0.45){ result='Win'; coins=state.sim.win; if(state.sim.pack) state.myPacks.push(state.sim.pack); }
  else if(r<0.70){ result='Draw'; coins=state.sim.draw; }
  state.coins += coins; renderCoins(state.coins); saveAll(); renderMine();
  alert(`${result} +${fmt(coins)}`);
}

/* ========= Overlay / Detail ========= */
EL('btnCloseOverlay').addEventListener('click', ()=>closeReveal(true));
EL('btnSendAll').addEventListener('click', ()=>{ closeReveal(true); });
EL('btnQSAll').addEventListener('click', ()=>{
  if(!overlayCards || !overlayCards.length){ closeReveal(false); return; }
  const sum = overlayCards.reduce((s,p)=>s+computeQSValue(p),0);
  state.coins += sum; state.stats.coinsFromQS += sum;
  overlayCards=[]; saveAll(); renderCoins(state.coins); closeReveal(false);
  alert(`Sold all for ${fmt(sum)} coins.`);
});

function showDetail(p){
  EL('m-ovr').textContent=p.ovr;
  EL('m-name').textContent=p.name + (p.type?` (${String(p.type).toUpperCase()})`:'');
  EL('m-pos').textContent=p.pos;
  EL('m-club').textContent=p.club+' '+STADIUM;
  EL('m-league').textContent=p.league;
  EL('m-nation').textContent=(FLAGS[p.nation]||'')+' '+(p.nation||'');
  EL('m-value').textContent='Quick sell '+fmt(computeQSValue(p));
  EL('m-sell').onclick=()=>{ const val=computeQSValue(p); state.coins+=val; state.stats.coinsFromQS+=val; removeFromClub(p); renderCoins(state.coins); closeModal(); saveAll(); };
  EL('modal').classList.add('show');
}
function closeModal(){EL('modal').classList.remove('show')}

/* ========= Init ========= */
function init(){renderAll();}
init();
</script>
</body>
</html>
